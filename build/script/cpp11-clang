#! /bin/sh
#
# $Id: //poco/1.4/build/script/cpp11-clang#1 $
#
# cpp11-clang
#
# Detect compatible Clang version and add c++11/14 flags
#

#APPLE_CLANGVERSION := $(subst .,,$(shell clang --version | grep ^Apple | sed 's/^.* //g' | sed 's/(clang\-\(.*\))/\1/g' | sed -e 's/\.\([0-9][0-9]\)/\1/g' -e 's/\.\([0-9]\)/0\1/g' -e 's/^[0-9]\{3,4\}$$/&00/' ))

# C++14 needs AppleClang 503.x
#ifeq ($(shell test $(APPLE_CLANGVERSION) -gt 5030038 && echo 1), 1)
#	CXXFLAGS += -std=c++14
# C++11 needs AppleClang 500.x
#else ifeq ($(shell test $(APPLE_CLANGVERSION) -gt 5000275 && echo 1), 1)
#	CXXFLAGS += -std=c++11
#endif

ISAPPLE      := $(shell $(CXX) -x c++ /dev/null -dM -E | grep __APPLE__ | sed -e 's/^.* //g')
CLANGMAJOR   := $(shell $(CXX) -x c++ /dev/null -dM -E | grep __clang_major__ | sed -e 's/^.* //g')
CLANGMINOR   := $(shell $(CXX) -x c++ /dev/null -dM -E | grep __clang_minor__ | sed -e 's/^.* //g')
CLANGPATCH   := $(shell $(CXX) -x c++ /dev/null -dM -E | grep __clang_patchlevel__ | sed -e 's/^.* //g')
CLANGVERSION := $(CLANGMAJOR)$(CLANGMINOR)

ifeq ($(shell test "$(ISAPPLE)" && echo 1), 1)
  # C++14 needs Clang 61
  ifeq ($(shell test $(CLANGVERSION) -ge 61 && echo 1), 1)
	  CXXFLAGS += -std=c++14
  # C++11 needs Clang 60
  else ifeq ($(shell test $(CLANGVERSION) -ge 60 && echo 1), 1)
	  CXXFLAGS += -std=c++11
  endif
else
  # C++14 needs Clang 3.5
  ifeq ($(shell test $(CLANGVERSION) -ge 35 && echo 1), 1)
	  CXXFLAGS += -std=c++14
  # C++11 needs Clang 3.3
  else ifeq ($(shell test $(CLANGVERSION) -ge 33 && echo 1), 1)
	  CXXFLAGS += -std=c++11
  endif
endif

